<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="style.css"/>
	<template id="spa_main_script">
		<div>
			{ spa_script | format_unescaped }
		</div>
	</template>
</head>
<body>
	<script>
		/* FIXME: so many escapes, this should come from a separate file */
		const project_list = \{
			{{ for project in projects }}
				["{ project.mnemonic }"]: { project.description | format_json },
			{{ endfor }}
		};

		const project_username = "{ username | arg_escape }";
		const script_element = document.getElementById('spa_main_script');
		const main_script = script_element.content.firstElementChild.innerText;

		let blob = new Blob([main_script], \{ type: 'application/javascript' });
		(async function() \{
			const blobURL = URL.createObjectURL(blob);
			const stage2 = (await import(blobURL));

			stage2.init_window(project_list, project_username);
		})();
	</script>

	<main>
		<h1 id="git-hackme-global-title">Hackable Projects</h1>

		<h3 style="display: inline">
			Brought by <div class="icon-github">
				<a href="{ repository | arg_escape }"></a>
			</div>
		</h3>

		<noscript><p>Some instructions are generated by Javascript, tailored to the hostname used to reach this webpage</p></noscript>

		<details>
		<summary>Manual instructions</summary>
		<ol>
			<li>Create a temporary folder, change directory into it</li>
			<li class="git-hackme-project-join-link">Provide the hostname <pre id="git-hackme-manual-join-hostname">export GIT_HACKME_HOST=see.document.url GIT_HACKME_HOSTNAME=see.document.hostname</pre></li>
			<li class="git-hackme-project-join-link">Download the three files <pre>\{key, key.pub, key-cert.pub}</pre> for each project</li>
				<li class="git-hackme-project-join-link">For instance <pre>wget -nH -r -l 2 $GIT_HACKME_HOST</pre></li>
				<li class="git-hackme-project-join-link">Protect the key files <pre>chmod 400 ./*/\{key,key.pub,key-cert.pub}</pre></li>
			<li class="git-hackme-project-join-link">Provide a project choice by mnemonic <pre>export GIT_HACKME_MNEMONIC=example-choose-from-below</pre></li>
				<li class="git-hackme-project-join-link">Create the SSH configuration from the <a href="ssh_config.template">template</a> <pre>envsubst &lt ssh_config.template &gt ssh_config </pre></li>
			<li class="git-hackme-project-join-link"><pre>git clone --config "core.sshCommand=ssh -F $(pwd)/ssh_config" $GIT_HACKME_MNEMONIC.hackme.local: OPTIONAL_NAME</pre></li>
		</ol>
		</details>

		<pre style="display: inline; padding-left: 1em">cargo install "{pkg_name}@{version}"</pre>
	{{ for project in projects }}
		<div class="git-hackme-project" id="git-hackme-project-{project.mnemonic}" style="border-style: solid">
			<a class="git-hackme-title" href="./{ project.mnemonic }">{ project.mnemonic }</a>
			<div class="git-hackme-project-join-link">
				<pre class="git-hackme-project-join-pre" id=cmd-join-{project.mnemonic}>Join command requires Js</pre>
				<button class="git-hackme-project-join-button" >Copy to clipboard</button>
			</div>
		</div>
	{{ endfor }}

	</main>
</body>
</html>
